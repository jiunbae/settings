IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKRml4IHByb2JsZW1hdGljIGNodW5rcyBieSByZS11cGxvYWRpbmcgd2l0aCBjb3JyZWN0IHh4aGFzaDY0IGFsZ29yaXRobS4KClRoaXMgc2NyaXB0OgoxLiBSZWFkcyBwcm9ibGVtYXRpYyBkb2N1bWVudHMgZnJvbSAvdG1wL3Byb2JsZW1hdGljX2RvY3MuanNvbgoyLiBEZWxldGVzIHRoZW0gZnJvbSBDb3VjaERCIChkb2N1bWVudCArIG9ycGhhbmVkIGNodW5rcykKMy4gUmUtdXBsb2FkcyBmcm9tIGxvY2FsIGZpbGVzIHdpdGggY29ycmVjdCB4eGhhc2g2NCBjaHVuayBJRHMKIiIiCgppbXBvcnQgdXJsbGliLnJlcXVlc3QKaW1wb3J0IHVybGxpYi5lcnJvcgppbXBvcnQganNvbgppbXBvcnQgYmFzZTY0CmltcG9ydCBzeXMKaW1wb3J0IG9zCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQppbXBvcnQgeHhoYXNoCgojIENvbmZpZ3VyYXRpb24KQ09VQ0hEQl9VUkkgPSAiaHR0cHM6Ly9vYnNpZGlhbi5qaXVuLmRldiIKQ09VQ0hEQl9VU0VSID0gImFkbWluIgpDT1VDSERCX1BBU1NXT1JEID0gIkppdW41NDg2QCMiCkNPVUNIREJfREIgPSAib2JzaWRpYW4iClZBVUxUX1JPT1QgPSBQYXRoLmhvbWUoKSAvICJzLWxhc3RvcmRlciIKCiMgQ2h1bmtpbmcgc2V0dGluZ3MgKG1hdGNoIExpdmVTeW5jIGNvbmZpZykKTUlOX0NIVU5LX1NJWkUgPSAyMApNQVhfQ0hVTktfU0laRSA9IDI1MCAqIDEwMjQgICMgMjUwS0IKCgpkZWYgY291Y2hkYl9yZXF1ZXN0KHBhdGgsIG1ldGhvZD0iR0VUIiwgZGF0YT1Ob25lKToKICAgICIiIk1ha2UgQ291Y2hEQiByZXF1ZXN0IiIiCiAgICB1cmwgPSBmIntDT1VDSERCX1VSSX0ve0NPVUNIREJfREJ9L3twYXRofSIKICAgIGlmIGRhdGE6CiAgICAgICAgcmVxID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdCh1cmwsIGRhdGE9anNvbi5kdW1wcyhkYXRhKS5lbmNvZGUoJ3V0Zi04JyksIG1ldGhvZD1tZXRob2QpCiAgICBlbHNlOgogICAgICAgIHJlcSA9IHVybGxpYi5yZXF1ZXN0LlJlcXVlc3QodXJsLCBtZXRob2Q9bWV0aG9kKQoKICAgIGNyZWRlbnRpYWxzID0gYmFzZTY0LmI2NGVuY29kZShmIntDT1VDSERCX1VTRVJ9OntDT1VDSERCX1BBU1NXT1JEfSIuZW5jb2RlKCkpLmRlY29kZSgpCiAgICByZXEuYWRkX2hlYWRlcignQXV0aG9yaXphdGlvbicsIGYnQmFzaWMge2NyZWRlbnRpYWxzfScpCiAgICByZXEuYWRkX2hlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKQoKICAgIHRyeToKICA=ICAgICAgd2l0aCB1cmxsaWIucmVxdWVzdC51cmxvcGVuKHJlcSwgdGltZW91dD02MCkgYXMgcmVzcDoKICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzcC5yZWFkKCkuZGVjb2RlKCkpCiAgICBleGNlcHQgdXJsbGliLmVycm9yLkhUVFBFcnJvciBhcyBlOgogICAgICAgIGlmIGUuY29kZSA9PSA0MDQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgcmFpc2UKCgpkZWYgaW50X3RvX2Jhc2UzNihuKToKICAgICIiIkNvbnZlcnQgaW50ZWdlciB0byBiYXNlMzYgc3RyaW5nIiIiCiAgICBpZiBuID09IDA6CiAgICAgICAgcmV0dXJuICIwIgogICAgY2hhcnMgPSAiMDEyMzQ1Njc4OWFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6IgogICAgcmVzdWx0ID0gIiIKICAgIHdoaWxlIG4gPiAwOgogICAgICAgIHJlc3VsdCA9IGNoYXJzW24gJSAzNl0gKyByZXN1bHQKICAgICAgICBuIC8vPSAzNgogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBnZW5lcmF0ZV9jaHVua19pZChkYXRhKToKICAgICIiIkdlbmVyYXRlIHh4aGFzaDY0IGNodW5rIElEIChtYXRjaGVzIExpdmVTeW5jKSIiIgogICAgaGFzaF9pbnB1dCA9IGYie2RhdGF9LXtsZW4oZGF0YSl9IgogICAgaCA9IHh4aGFzaC54eGg2NChoYXNoX2lucHV0LmVuY29kZSgndXRmLTgnKSkuaW50ZGlnZXN0KCkKICAgIHJldHVybiBmImg6e2ludF90b19iYXNlMzYoaCl9IgoKCmRlZiBzcGxpdF9jb250ZW50KGNvbnRlbnQsIG1heF9zaXplPU1BWF9DSFVOS19TSVpFLCBtaW5fc2l6ZT1NSU5fQ0hVTktfU0laRSk6CiAgICAiIiJTcGxpdCBjb250ZW50IGludG8gY2h1bmtzIHVzaW5nIHNpbXBsZSBsaW5lLWJhc2VkIHNwbGl0dGluZyIiIgogICAgaWYgbm90IGNvbnRlbnQ6CiAgICAgICAgcmV0dXJuIFtdCgogICAgY2h1bmtzID0gW10KICAgIGxpbmVzID0gY29udGVudC5zcGxpdCgnXG4nKQogICAgY3VycmVudF9jaHVuayA9ICIiCgogICAgZm9yIGksIGxpbmUgaW4gZW51bWVyYXRlKGxpbmVzKToKICAgICAgICB0ZXN0X2NodW5rID0gY3VycmVudF9jaHVuayArIGxpbmUgKyAoJ1xuJyBpZiBpIDwgbGVuKGxpbmVzKSAtIDEgZWxzZSAnJykKCiAgICAgICAgaWYgbGVuKHRlc3RfY2h1bmsuZW5jb2RlKCd1dGYtOCcpKSA+IG1heF9zaXplOgogICAgICAgICAgICBpZiBjdXJyZW50X2NodW5rOgogICAgICAgICAgICAgICAgY2h1bmtzLmFwcGVuZChjdXJyZW50X2NodW5rKQogICAgICAgICAgICBjdXJyZW50X2NodW5rID0gbGluZSArICgnXG4nIGlmIGkgPCBsZW4obGluZXMpIC0gMSBlbHNlICcnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGN1cnJlbnRfY2h1bmsgPSB0ZXN0X2NodW5rCgogICAgaWYgY3VycmVudF9jaHVuazoKICAgICAgICBjaHVua3MuYXBwZW5kKGN1cnJlbnRfY2h1bmspCgogICAgcmV0dXJuIGNodW5rcwoKCmRlZiBkZWxldGVfZG9jdW1lbnQoZG9jX2lkKToKICAgICIiIkRlbGV0ZSBkb2N1bWVudCBmcm9tIENvdWNoREIgKGdldHMgY3VycmVudCByZXYgZmlyc3QpIiIiCiAgICBlbmNvZGVkX2lkID0gdXJsbGliLnJlcXVlc3QucXVvdGUoZG9jX2lkLCBzYWZlPScnKQogICAgdHJ5OgogICAgICAgICMgR2V0IGN1cnJlbnQgcmV2aXNpb24KICAgICAgICBkb2MgPSBjb3VjaGRiX3JlcXVlc3QoZW5jb2RlZF9pZCkKICAgICAgICBpZiBub3QgZG9jOgogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBBbHJlYWR5IGRlbGV0ZWQKCiAgICAgICAgcmV2ID0gZG9jLmdldCgnX3JldicpCiAgICAgICAgY291Y2hkYl9yZXF1ZXN0KGYie2VuY29kZWRfaWR9P3Jldj17cmV2fSIsIG1ldGhvZD0iREVMRVRFIikKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiICBFcnJvciBkZWxldGluZyB7ZG9jX2lkfToge2V9IikKICAgICAgICByZXR1cm4gRmFsc2UKCgpkZWYgdXBsb2FkX2RvY3VtZW50KGRvY19pZCwgY29udGVudCwgbXRpbWU9Tm9uZSk6CiAgICAiIiJVcGxvYWQgZG9jdW1lbnQgd2l0aCBjb3JyZWN0IHh4aGFzaDY0IGNodW5rcyIiIgogICAgIyBTcGxpdCBjb250ZW50IGludG8gY2h1bmtzCiAgICBjaHVua3MgPSBzcGxpdF9jb250ZW50KGNvbnRlbnQpCgogICAgaWYgbm90IGNodW5rczoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBjaHVua19pZHMgPSBbXQoKICAgICMgVXBsb2FkIGVhY2ggY2h1bmsKICAgIGZvciBjaHVua19kYXRhIGluIGNodW5rczoKICAgICAgICBjaHVua19pZCA9IGdlbmVyYXRlX2NodW5rX2lkKGNodW5rX2RhdGEpCiAgICAgICAgY2h1bmtfaWRzLmFwcGVuZChjaHVua19pZCkKCiAgICAgICAgIyBDaGVjayBpZiBjaHVuayBhbHJlYWR5IGV4aXN0cwogICAgICAgIGVuY29kZWRfY2h1bmtfaWQgPSB1cmxsaWIucmVxdWVzdC5xdW90ZShjaHVua19pZCwgc2FmZT0nJykKICAgICAgICBleGlzdGluZyA9IGNvdWNoZGJfcmVxdWVzdChlbmNvZGVkX2NodW5rX2lkKQoKICAgICAgICBpZiBub3QgZXhpc3Rpbmc6CiAgICAgICAgICAgICMgQ3JlYXRlIGNodW5rIGRvY3VtZW50CiAgICAgICAgICAgIGNodW5rX2RvYyA9IHsKICAgICAgICAgICAgICAgICdfaWQnOiBjaHVua19pZCwKICAgICAgICAgICAgICAgICdkYXRhJzogY2h1bmtfZGF0YSwKICAgICAgICAgICAgICAgICd0eXBlJzogJ2xlYWYnCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY291Y2hkYl9yZXF1ZXN0KGVuY29kZWRfY2h1bmtfaWQsIG1ldGhvZD0iUFVUIiwgZGF0YT1jaHVua19kb2MpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiICBFcnJvciB1cGxvYWRpbmcgY2h1bmsge2NodW5rX2lkfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICMgQ3JlYXRlIG1haW4gZG9jdW1lbnQKICAgIG5vdyA9IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpCiAgICBkb2MgPSB7CiAgICAgICAgJ19pZCc6IGRvY19pZCwKICAgICAgICAnY2hpbGRyZW4nOiBjaHVua19pZHMsCiAgICAgICAgJ2N0aW1lJzogbXRpbWUgb3Igbm93LAogICAgICAgICdtdGltZSc6IG10aW1lIG9yIG5vdywKICAgICAgICAnc2l6ZSc6IGxlbihjb250ZW50KSwKICAgICAgICAndHlwZSc6ICdwbGFpbicKICAgIH0KCiAgICBlbmNvZGVkX2RvY19pZCA9IHVybGxpYi5yZXF1ZXN0LnF1b3RlKGRvY19pZCwgc2FmZT0nJykKCiAgICAjIENoZWNrIGlmIGRvY3VtZW50IGV4aXN0cyAoZ2V0IHJldikKICAgIGV4aXN0aW5nID0gY291Y2hkYl9yZXF1ZXN0KGVuY29kZWRfZG9jX2lkKQogICAgaWYgZXhpc3Rpbmc6CiAgICAgICAgZA==b2NbJ19yZXYnXSA9IGV4aXN0aW5nWydfcmV2J10KCiAgICB0cnk6CiAgICAgICAgY291Y2hkYl9yZXF1ZXN0KGVuY29kZWRfZG9jX2lkLCBtZXRob2Q9IlBVVCIsIGRhdGE9ZG9jKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiIgIEVycm9yIHVwbG9hZGluZyBkb2N1bWVudCB7ZG9jX2lkfToge2V9IikKICAgICAgICByZXR1cm4gRmFsc2UKCgpkZWYgZml4X2RvY3VtZW50KGRvY19pbmZvLCBkcnlfcnVuPUZhbHNlKToKICAgICIiIkZpeCBhIHNpbmdsZSBkb2N1bWVudCIiIgogICAgZG9jX2lkID0gZG9jX2luZm9bJ2lkJ10KCiAgICAjIEZpbmQgbG9jYWwgZmlsZQogICAgbG9jYWxfcGF0aCA9IFZBVUxUX1JPT1QgLyBkb2NfaWQKCiAgICBpZiBub3QgbG9jYWxfcGF0aC5leGlzdHMoKToKICAgICAgICBwcmludChmIiAgW1NLSVBdIHtkb2NfaWR9IC0gbG9jYWwgZmlsZSBub3QgZm91bmQiKQogICAgICAgIHJldHVybiBGYWxzZQoKICAgICMgUmVhZCBsb2NhbCBjb250ZW50CiAgICB0cnk6CiAgICAgICAgY29udGVudCA9IGxvY2FsX3BhdGgucmVhZF90ZXh0KGVuY29kaW5nPSd1dGYtOCcpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiIgIFtFUlJPUl0ge2RvY19pZH0gLSBjYW5ub3QgcmVhZDoge2V9IikKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBtdGltZSA9IGRhdGV0aW1lLmZyb210aW1lc3RhbXAobG9jYWxfcGF0aC5zdGF0KCkuc3RfbXRpbWUpLmlzb2Zvcm1hdCgpCgogICAgaWYgZHJ5X3J1bjoKICAgICAgICBwcmludChmIiAgW0RSWS1SVU5dIHtkb2NfaWR9ICh7bGVuKGNvbnRlbnQpfSBjaGFycykiKQogICAgICAgIHJldHVybiBUcnVlCgogICAgIyBEZWxldGUgb2xkIGRvY3VtZW50IChnZXRzIGN1cnJlbnQgcmV2IGF1dG9tYXRpY2FsbHkpCiAgICBpZiBub3QgZGVsZXRlX2RvY3VtZW50KGRvY19pZCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgIyBVcGxvYWQgd2l0aCBjb3JyZWN0IGNodW5rcwogICAgaWYgbm90IHVwbG9hZF9kb2N1bWVudChkb2NfaWQsIGNvbnRlbnQsIG10aW1lKToKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBwcmludChmIiAgW0ZJWEVEXSB7ZG9jX2lkfSIpCiAgICByZXR1cm4gVHJ1ZQoKCmRlZiBtYWluKCk6CiAgICBpbXBvcnQgYXJncGFyc2UKICAgIHBhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFyc2VyKGRlc2NyaXB0aW9uPSJGaXggcHJvYmxlbWF0aWMgY2h1bmtzIikKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tZHJ5LXJ1bicsIGFjdGlvbj0nc3RvcmVfdHJ1ZScsIGhlbHA9J1ByZXZpZXcgd2l0aG91dCBjaGFuZ2VzJykKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tbGltaXQnLCB0eXBlPWludCwgZGVmYXVsdD0wLCBoZWxwPSdMaW1pdCBudW1iZXIgb2YgZG9jdW1lbnRzJykKICAgIGFyZ3MgPSBwYXJzZXIucGFyc2VfYXJncygpCgogICAgIyBMb2FkIHByb2JsZW1hdGljIGRvY3VtZW50cwogICAgd2l0aCBvcGVuKCcvdG1wL3Byb2JsZW1hdGljX2RvY3MuanNvbicpIGFzIGY6CiAgICAgICAgZG9jcyA9IGpzb24ubG9hZChmKQoKICAgIHByaW50KGYiTG9hZGVkIHtsZW4oZG9jcyl9IHByb2JsZW1hdGljIGRvY3VtZW50cyIpCgogICAgaWYgYXJncy5saW1pdDoKICAgICAgICBkb2NzID0gZG9jc1s6YXJncy5saW1pdF0KICAgICAgICBwcmludChmIlByb2Nlc3NpbmcgZmlyc3Qge2FyZ3MubGltaXR9IGRvY3VtZW50cyIpCgogICAgaWYgYXJncy5kcnlfcnVuOgogICAgICAgIHByaW50KCJbRFJZIFJVTiBNT0RFXSIpCgogICAgcHJpbnQoKQoKICAgIGZpeGVkID0gMAogICAgc2tpcHBlZCA9IDAKICAgIGVycm9ycyA9IDAKCiAgICBmb3IgaSwgZG9jIGluIGVudW1lcmF0ZShkb2NzKToKICAgICAgICBpZiAoaSArIDEpICUgMTAwID09IDA6CiAgICAgICAgICAgIHByaW50KGYiUHJvZ3Jlc3M6IHtpICsgMX0ve2xlbihkb2NzKX0iKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGZpeF9kb2N1bWVudChkb2MsIGRyeV9ydW49YXJncy5kcnlfcnVuKToKICAgICAgICAgICAgICAgIGZpeGVkICs9IDEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNraXBwZWQgKz0gMQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiIgIFtFUlJPUl0ge2RvY1snaWQnXX06IHtlfSIpCiAgICAgICAgICAgIGVycm9ycyArPSAxCgogICAgcHJpbnQoKQogICAgcHJpbnQoIj0iICogNTApCiAgICBwcmludChmIkZpeGVkOiB7Zml4ZWR9IikKICAgIHByaW50KGYiU2tpcHBlZDoge3NraXBwZWR9IikKICAgIHByaW50KGYiRXJyb3JzOiB7ZXJyb3JzfSIpCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIG1haW4oKQo=